"use strict";

var nodemailer = require('nodemailer')
{% if pepyatka_mailer_smtp_enabled %}
var smtpTransport = require('nodemailer-smtp-transport')
var transport = nodemailer.createTransport(smtpTransport({
    host: '{{ pepyatka_mailer_smtp_host }}',
    port: {{ pepyatka_mailer_smtp_port }},
    secure: {{ pepyatka_mailer_smtp_secure }},
    auth: {
        user: '{{ pepyatka_mailer_smtp_user }}',
        pass: '{{ pepyatka_mailer_smtp_pass }}'
    }
}))
{% else %}
var transport = {
  name: 'minimal',
  version: '0.1.0',
  send: function(mail, callback) {
    var input = mail.message.createReadStream();
    input.pipe(process.stdout);
    input.on('end', function() {
      callback(null, true)
    })
  }
}
{% endif %}

exports.getConfig = function() {
  var config = {
    port: {{ pepyatka_server_port }},
    database: 2,

    secret: '{{ pepyatka_secret }}',

    origin: '{{ pepyatka_hostname }}',

    serviceName: 'FreeFeed',
    appRoot: '{{ pepyatka_home_dir}}/pepyatka-server'
  }

  config.attachments = {
    // Make sure that all directories here have a trailing slash
    urlDir: '{{ pepyatka_use_ssl | ternary("https","http") }}://{{ pepyatka_hostname}}/attachments/original/',
    fsDir: '{{ pepyatka_files_dir }}/original/',
    fileSizeLimit: '{{ pepyatka_file_size_limit }}',

    thumbnails: {
      urlDir: '{{ pepyatka_use_ssl | ternary("https","http") }}://{{ pepyatka_hostname}}/attachments/thumbnails/',
      fsDir: '{{ pepyatka_files_dir }}/thumbnails/'
    }
  }

  config.profilePictures = {
    urlDir: '{{ pepyatka_use_ssl | ternary("https","http") }}://{{ pepyatka_hostname}}/files/profilePictures/',
    fsDir: '{{ pepyatka_files_dir }}/profilePictures/'
  }

  config.mailer = {
    transport: transport,
    fromName: '{{ pepyatka_mailer_from_name }}',
    fromEmail: '{{ pepyatka_mailer_from_email }}',
    host: '{{ pepyatka_use_ssl | ternary("https","http") }}://{{ pepyatka_hostname}}',
    resetPasswordTemplate: '{{ pepyatka_home_dir }}/pepyatka-server/app/scripts/views/mailer/resetPassword.ejs',
    resetPasswordMailSubject: 'FreeFeed password reset',
    mailFooter: 'Thank you,\nFreeFeed dev team'
  }

  config.redis = {
    host: '{{ pepyatka_redis_host }}',
    port: {{ pepyatka_redis_port }}
  }

  return config
}
