---

- fail: msg="Pepyatka server is only supported for Ubuntu"
  when: ansible_distribution != 'Ubuntu'

- name: Add the myway apt repository
  apt_repository: repo="ppa:dhor/myway" state=present
  tags:
    - graphicsmagick
    - pepyatka

- name: Install GraphicsMagick
  apt: name=graphicsmagick state=present update-cache=yes
  tags:
    - graphicsmagick
    - pepyatka

- name: Create pepyatka user
  user:
    name: "{{ pepyatka_user }}"
    home: "{{ pepyatka_home_dir }}"
    createhome: yes
    system: yes
  tags:
    - pepyatka

- name: Ensure git is installed
  apt: name=git state=present

- name: Deploy pepyatka-server
  su: yes
  su_user: "{{ pepyatka_user }}"
  git:
    repo: "{{ pepyatka_server_repo }}"
    update: yes
    dest: "{{ pepyatka_home_dir }}/pepyatka-server"
    version: "{{ pepyatka_version }}"
  notify:
    - restart pepyatka
  tags:
    - pepyatka

- name: Fix server name in development.js
  su: yes
  su_user: "{{ pepyatka_user }}"
  replace:
    dest: "{{ pepyatka_home_dir }}/pepyatka-server/config/environments/development.js"
    regexp: "http://localhost:3333"
    replace: "https://{{ fe_hostname }}"
  notify:
    - restart pepyatka
  tags:
    - pepyatka

- name: Install pepyatka-server dependencies
  su: yes
  su_user: "{{ pepyatka_user }}"
  npm: path="{{ pepyatka_home_dir }}/pepyatka-server"
  tags:
    - pepyatka

- name: Install pm2
  npm: name=pm2 global=yes state=latest
  tags:
    - pepyatka

- name: Init pm2
  command: "pm2 startup ubuntu -u {{ pepyatka_user }}"
  tags:
    - pepyatka

- name: Get list of Node.js apps running
  su: yes
  su_user: "{{ pepyatka_user }}"
  command: pm2 list
  register: pm2_list
  changed_when: false
  tags:
    - pepyatka

- name: Start pepyatka-server
  su: yes
  su_user: "{{ pepyatka_user }}"
  environment:
    NODE_ENV: development
  command: chdir="{{ pepyatka_home_dir }}" pm2 start pepyatka-server/index.js -i 0 --name pepyatka
  when: "pm2_list.stdout.find('pepyatka') == -1"
  tags:
    - pepyatka

- name: Ensure pepyatka is up and running
  wait_for: host=localhost port=3000 timeout=30 state=started
  tags:
    - nginx
